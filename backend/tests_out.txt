============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-7.4.4, pluggy-1.5.0
rootdir: /home/nicola/dev/E80_pm_mockup/backend
plugins: anyio-4.6.0
collected 269 items

tests/api/routes/test_baseline_cost_elements_by_wbe.py ......            [  2%]
tests/api/routes/test_baseline_cost_elements_list.py ......              [  4%]
tests/api/routes/test_baseline_logs.py ....................              [ 11%]
tests/api/routes/test_baseline_snapshot_summary.py ......                [ 14%]
tests/api/routes/test_budget_summary.py ......                           [ 16%]
tests/api/routes/test_budget_timeline.py ..........                      [ 20%]
tests/api/routes/test_cost_categories.py ...                             [ 21%]
tests/api/routes/test_cost_element_schedules.py ...........              [ 25%]
tests/api/routes/test_cost_element_types.py ...                          [ 26%]
tests/api/routes/test_cost_elements.py ....................              [ 33%]
tests/api/routes/test_cost_registrations.py .............                [ 38%]
tests/api/routes/test_cost_summary.py ..........                         [ 42%]
tests/api/routes/test_login.py .......                                   [ 44%]
tests/api/routes/test_private.py .                                       [ 45%]
tests/api/routes/test_projects.py ............                           [ 49%]
tests/api/routes/test_users.py .........................                 [ 59%]
tests/api/routes/test_wbes.py ..............                             [ 64%]
tests/core/test_seeds.py ...FFFFFFFF                                     [ 68%]
tests/crud/test_user.py FFFFFFFFF                                        [ 71%]
tests/models/test_audit_log.py FF.                                       [ 72%]
tests/models/test_baseline_cost_element.py FFF.                          [ 74%]
tests/models/test_baseline_log.py FFF.FF                                 [ 76%]
tests/models/test_baseline_snapshot.py FF.FF                             [ 78%]
tests/models/test_budget_allocation.py FFF.                              [ 79%]
tests/models/test_change_order.py FF.                                    [ 81%]
tests/models/test_cost_element.py FFFF.                                  [ 82%]
tests/models/test_cost_element_schedule.py FF.                           [ 84%]
tests/models/test_cost_element_type.py FFF.FF                            [ 86%]
tests/models/test_cost_registration.py FF.                               [ 87%]
tests/models/test_department.py FF.                                      [ 88%]
tests/models/test_earned_value_entry.py F..                              [ 89%]
tests/models/test_forecast.py FF.                                        [ 90%]
tests/models/test_model_imports.py ..F                                   [ 91%]
tests/models/test_project.py FFFF.                                       [ 93%]
tests/models/test_project_event.py FF.                                   [ 94%]
tests/models/test_project_phase.py FFF.                                  [ 96%]
tests/models/test_quality_event.py FFF.                                  [ 97%]
tests/models/test_wbe.py FFF.                                            [ 99%]
tests/scripts/test_backend_pre_start.py .                                [ 99%]
tests/scripts/test_test_pre_start.py .E                                  [100%]

==================================== ERRORS ====================================
_____________ ERROR at teardown of test_init_successful_connection _____________

    @pytest.fixture(scope="session", autouse=True)
    def db() -> Generator[Session, None, None]:
        with Session(engine) as session:
            init_db(session)
            yield session
            # Clean up all tables in reverse dependency order
            statement = delete(
                EarnedValueEntry
            )  # Must be before CostElement/BaselineLog/User due to FK
>           session.execute(statement)

tests/conftest.py:44:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:127: in execute
    return super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2226: in _execute_internal
    ) = compile_state_cls.orm_pre_session_exec(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/bulk_persistence.py:726: in orm_pre_session_exec
    session._autoflush()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:3050: in _autoflush
    self.flush()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4352: in flush
    self._flush(objects)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4444: in _flush
    flush_context.transaction = transaction = self._autobegin_t()._begin()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = '_begin', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
----------------------------- Captured stderr call -----------------------------
INFO:app.tests_pre_start:Starting call to 'app.tests_pre_start.init', this is the 1st time calling it.
------------------------------ Captured log call -------------------------------
INFO     app.tests_pre_start:before.py:42 Starting call to 'app.tests_pre_start.init', this is the 1st time calling it.
=================================== FAILURES ===================================
______________________ test_seed_order_departments_first _______________________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff1056a0>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f70ff105550>
parameters = [{}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a53d0>
query = 'DELETE FROM costelement', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.ForeignKeyViolation: update or delete on table "costelement" violates foreign key constraint "baselinecostelement_cost_element_id_fkey" on table "baselinecostelement"
E           DETAIL:  Key (cost_element_id)=(2c8769c9-3bd5-4d72-9490-b7b8fa4524ed) is still referenced from table "baselinecostelement".

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: ForeignKeyViolation

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_seed_order_departments_first(db: Session) -> None:
        """Integration test: departments must be seeded before cost element types."""
        from app.core.db import init_db

        # Clear existing data in correct dependency order
        # Delete records that reference CostElement first
        statement = delete(EarnedValueEntry)
        db.execute(statement)
        statement = delete(Forecast)
        db.execute(statement)
        statement = delete(QualityEvent)
        db.execute(statement)
        statement = delete(BudgetAllocation)
        db.execute(statement)
        statement = delete(CostRegistration)
        db.execute(statement)
        statement = delete(CostElementSchedule)
        db.execute(statement)
        # Delete CostElement (references CostElementType)
        statement = delete(CostElement)
>       db.execute(statement)

tests/core/test_seeds.py:138:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:127: in execute
    return super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/bulk_persistence.py:1982: in orm_execute_statement
    return super().orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a53d0>
query = 'DELETE FROM costelement', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.IntegrityError: (psycopg.errors.ForeignKeyViolation) update or delete on table "costelement" violates foreign key constraint "baselinecostelement_cost_element_id_fkey" on table "baselinecostelement"
E           DETAIL:  Key (cost_element_id)=(2c8769c9-3bd5-4d72-9490-b7b8fa4524ed) is still referenced from table "baselinecostelement".
E           [SQL: DELETE FROM costelement]
E           (Background on this error at: https://sqlalche.me/e/20/gkpj)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: IntegrityError
___________________ test_seed_cost_element_types_still_works ___________________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff106600>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f70ff3aa660>
parameters = [{}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70fff19a90>
query = 'DELETE FROM earnedvalueentry', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_seed_cost_element_types_still_works(db: Session) -> None:
        """Regression test: verify cost element types seed function still works after refactor."""
        # Clear existing data in correct dependency order
        # Delete records that reference CostElement first
        statement = delete(EarnedValueEntry)
>       db.execute(statement)

tests/core/test_seeds.py:175:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:127: in execute
    return super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/bulk_persistence.py:1982: in orm_execute_statement
    return super().orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70fff19a90>
query = 'DELETE FROM earnedvalueentry', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: DELETE FROM earnedvalueentry]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
______________ test_seed_cost_element_types_with_hardcoded_uuids _______________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff68c350>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f70ff3aa660>
parameters = [{}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a56d0>
query = 'DELETE FROM earnedvalueentry', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_seed_cost_element_types_with_hardcoded_uuids(db: Session) -> None:
        """Test that cost element types are created with hardcoded UUIDs from JSON."""
        import json
        from pathlib import Path

        # Clear existing data in correct dependency order
        # Delete records that reference CostElement first
        statement = delete(EarnedValueEntry)
>       db.execute(statement)

tests/core/test_seeds.py:223:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:127: in execute
    return super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/bulk_persistence.py:1982: in orm_execute_statement
    return super().orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a56d0>
query = 'DELETE FROM earnedvalueentry', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: DELETE FROM earnedvalueentry]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
_______________ test_seed_project_from_template_creates_project ________________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff64a6c0>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f710492b770>
parameters = [{'email_1': 'admin@example.com'}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a4350>
query = 'SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at \nFROM "user" \nWHERE "user".email = %(email_1)s::VARCHAR'
params = {'email_1': 'admin@example.com'}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_seed_project_from_template_creates_project(db: Session) -> None:
        """Test that _seed_project_from_template creates project from JSON file."""
        # Ensure prerequisites exist: departments, cost element types, and first superuser
        from app import crud
        from app.core.config import settings
        from app.models import User, UserCreate, UserRole

        # Create first superuser if it doesn't exist
>       user = db.exec(select(User).where(User.email == settings.FIRST_SUPERUSER)).first()

tests/core/test_seeds.py:288:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:66: in exec
    results = super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a4350>
query = 'SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at \nFROM "user" \nWHERE "user".email = %(email_1)s::VARCHAR'
params = {'email_1': 'admin@example.com'}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at
E           FROM "user"
E           WHERE "user".email = %(email_1)s::VARCHAR]
E           [parameters: {'email_1': 'admin@example.com'}]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
__________________ test_seed_project_from_template_idempotent __________________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff3f3a10>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f710492b770>
parameters = [{'email_1': 'admin@example.com'}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a5910>
query = 'SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at \nFROM "user" \nWHERE "user".email = %(email_1)s::VARCHAR'
params = {'email_1': 'admin@example.com'}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_seed_project_from_template_idempotent(db: Session) -> None:
        """Test that _seed_project_from_template updates existing project by project_code."""
        # Ensure prerequisites exist
        from app import crud
        from app.core.config import settings
        from app.models import User, UserCreate, UserRole

>       user = db.exec(select(User).where(User.email == settings.FIRST_SUPERUSER)).first()

tests/core/test_seeds.py:331:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:66: in exec
    results = super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a5910>
query = 'SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at \nFROM "user" \nWHERE "user".email = %(email_1)s::VARCHAR'
params = {'email_1': 'admin@example.com'}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at
E           FROM "user"
E           WHERE "user".email = %(email_1)s::VARCHAR]
E           [parameters: {'email_1': 'admin@example.com'}]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
_________________ test_seed_project_from_template_missing_file _________________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff48e2d0>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f71059d7770>
parameters = [{}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a4290>
query = 'SELECT project.project_name, project.customer_name, project.contract_value, project.project_code, project.pricelist_c..., project.notes, project.project_id, project.project_manager_id, project.created_at, project.updated_at \nFROM project'
params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_seed_project_from_template_missing_file(db: Session) -> None:
        """Test that _seed_project_from_template handles missing file gracefully."""
        # Count before
>       count_before = len(db.exec(select(Project)).all())

tests/core/test_seeds.py:389:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:66: in exec
    results = super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a4290>
query = 'SELECT project.project_name, project.customer_name, project.contract_value, project.project_code, project.pricelist_c..., project.notes, project.project_id, project.project_manager_id, project.created_at, project.updated_at \nFROM project'
params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: SELECT project.project_name, project.customer_name, project.contract_value, project.project_code, project.pricelist_code, project.start_date, project.planned_completion_date, project.actual_completion_date, project.status, project.notes, project.project_id, project.project_manager_id, project.created_at, project.updated_at
E           FROM project]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
_____________________ test_integration_all_seeds_together ______________________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff3f26c0>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f70ff3aa660>
parameters = [{}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a4d10>
query = 'DELETE FROM earnedvalueentry', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_integration_all_seeds_together(db: Session) -> None:
        """Integration test: verify all seeds work together in the correct order."""
        from app.core.db import init_db

        # Clear all data in correct dependency order
        # Delete records that reference CostElement first
        statement = delete(EarnedValueEntry)
>       db.execute(statement)

tests/core/test_seeds.py:416:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:127: in execute
    return super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/bulk_persistence.py:1982: in orm_execute_statement
    return super().orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70ff5a4d10>
query = 'DELETE FROM earnedvalueentry', params = {}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: DELETE FROM earnedvalueentry]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
___ test_seed_project_from_template_creates_budget_allocations_and_schedules ___

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff407290>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f710492b770>
parameters = [{'email_1': 'admin@example.com'}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70fff1abd0>
query = 'SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at \nFROM "user" \nWHERE "user".email = %(email_1)s::VARCHAR'
params = {'email_1': 'admin@example.com'}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_seed_project_from_template_creates_budget_allocations_and_schedules(
        db: Session,
    ) -> None:
        """Test that _seed_project_from_template creates budget allocations and schedules for cost elements."""
        from app import crud
        from app.core.config import settings
        from app.models import User, UserCreate, UserRole

        # Ensure prerequisites exist
>       user = db.exec(select(User).where(User.email == settings.FIRST_SUPERUSER)).first()

tests/core/test_seeds.py:488:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:66: in exec
    results = super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2247: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:305: in orm_execute_statement
    result = conn.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [INERROR] (host=localhost user=postgres database=app) at 0x7f70fff1abd0>
query = 'SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at \nFROM "user" \nWHERE "user".email = %(email_1)s::VARCHAR'
params = {'email_1': 'admin@example.com'}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: SELECT "user".email, "user".is_active, "user".role, "user".department, "user".full_name, "user".id, "user".hashed_password, "user".created_at, "user".updated_at
E           FROM "user"
E           WHERE "user".email = %(email_1)s::VARCHAR]
E           [parameters: {'email_1': 'admin@example.com'}]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
_______________________________ test_create_user _______________________________

self = <sqlalchemy.engine.base.Connection object at 0x7f70ff241d30>
dialect = <sqlalchemy.dialects.postgresql.psycopg.PGDialect_psycopg object at 0x7f7107ce08c0>
context = <sqlalchemy.dialects.postgresql.psycopg.PGExecutionContext_psycopg object at 0x7f70ff55e330>
statement = <sqlalchemy.dialects.postgresql.psycopg.PGCompiler_psycopg object at 0x7f7104e276b0>
parameters = [{'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'department': None, 'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'full_name': None, ...}]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.

        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()

            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )

        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )

        effective_parameters: Optional[_AnyExecuteParams]

        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters

        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )

        if self._echo:
            self._log_info(str_statement)

            stats = context._get_cache_stats()

            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )

        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [IDLE] (host=localhost user=postgres database=app) at 0x7f70fff18290>
query = 'INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUE...UID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)'
params = {'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'department': None, 'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'full_name': None, ...}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           psycopg.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InFailedSqlTransaction

The above exception was the direct cause of the following exception:

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_user(db: Session) -> None:
        email = random_email()
        password = random_lower_string()
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:14:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1313: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:1288: in _prepare_impl
    self.session.flush()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4352: in flush
    self._flush(objects)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4487: in _flush
    with util.safe_reraise():
.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py:146: in __exit__
    raise exc_value.with_traceback(exc_tb)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4448: in _flush
    flush_context.execute()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:466: in execute
    rec.execute(self)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:93: in save_obj
    _emit_insert_statements(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py:1048: in _emit_insert_statements
    result = connection.execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1418: in execute
    return meth(
.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py:515: in _execute_on_connection
    return connection._execute_clauseelement(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1640: in _execute_clauseelement
    ret = self._execute_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1846: in _execute_context
    return self._exec_single_context(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1986: in _exec_single_context
    self._handle_dbapi_exception(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:2355: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py:1967: in _exec_single_context
    self.dialect.do_execute(
.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py:941: in do_execute
    cursor.execute(statement, parameters)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <psycopg.Cursor [closed] [IDLE] (host=localhost user=postgres database=app) at 0x7f70fff18290>
query = 'INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUE...UID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)'
params = {'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'department': None, 'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'full_name': None, ...}

    def execute(
        self,
        query: Query,
        params: Params | None = None,
        *,
        prepare: bool | None = None,
        binary: bool | None = None,
    ) -> Self:
        """
        Execute a query or command to the database.
        """
        try:
            with self._conn.lock:
                self._conn.wait(
                    self._execute_gen(query, params, prepare=prepare, binary=binary)
                )
        except e._NO_TRACEBACK as ex:
>           raise ex.with_traceback(None)
E           sqlalchemy.exc.InternalError: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E           [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E           [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E           (Background on this error at: https://sqlalche.me/e/20/2j85)

.venv/lib/python3.12/site-packages/psycopg/cursor.py:97: InternalError
____________________________ test_authenticate_user ____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_authenticate_user(db: Session) -> None:
        email = random_email()
        password = random_lower_string()
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:23:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_not_authenticate_user __________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_not_authenticate_user(db: Session) -> None:
        email = random_email()
        password = random_lower_string()
>       user = crud.authenticate(session=db, email=email, password=password)

tests/crud/test_user.py:32:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:40: in authenticate
    db_user = get_user_by_email(session=session, email=email)
app/crud.py:35: in get_user_by_email
    session_user = session.exec(statement).first()
.venv/lib/python3.12/site-packages/sqlmodel/orm/session.py:66: in exec
    results = super().execute(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2362: in execute
    return self._execute_internal(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2226: in _execute_internal
    ) = compile_state_cls.orm_pre_session_exec(
.venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py:561: in orm_pre_session_exec
    session._autoflush()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:3050: in _autoflush
    self.flush()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4352: in flush
    self._flush(objects)
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:4444: in _flush
    flush_context.transaction = transaction = self._autobegin_t()._begin()
<string>:2: in _begin
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = '_begin', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_________________________ test_check_if_user_is_active _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_check_if_user_is_active(db: Session) -> None:
        email = random_email()
        password = random_lower_string()
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:40:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
____________________ test_check_if_user_is_active_inactive _____________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_check_if_user_is_active_inactive(db: Session) -> None:
        email = random_email()
        password = random_lower_string()
        user_in = UserCreate(email=email, password=password, is_active=True)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:48:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_________________________ test_check_if_user_is_admin __________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_check_if_user_is_admin(db: Session) -> None:
        email = random_email()
        password = random_lower_string()
        user_in = UserCreate(email=email, password=password, role=UserRole.admin)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:56:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
______________________ test_check_if_user_is_normal_user _______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_check_if_user_is_normal_user(db: Session) -> None:
        username = random_email()
        password = random_lower_string()
        user_in = UserCreate(email=username, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:64:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________________ test_get_user _________________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_get_user(db: Session) -> None:
        password = random_lower_string()
        username = random_email()
        user_in = UserCreate(email=username, password=password, role=UserRole.admin)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:72:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_______________________________ test_update_user _______________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_update_user(db: Session) -> None:
        password = random_lower_string()
        email = random_email()
        user_in = UserCreate(email=email, password=password, role=UserRole.admin)
>       user = crud.create_user(session=db, user_create=user_in)

tests/crud/test_user.py:83:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
____________________________ test_create_audit_log _____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_audit_log(db: Session) -> None:
        """Test creating an audit log entry."""
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_audit_log.py:20:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_audit_log_action_enum __________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_audit_log_action_enum(db: Session) -> None:
        """Test that action is validated."""
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_audit_log.py:55:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
______________________ test_create_baseline_cost_element _______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_baseline_cost_element(db: Session) -> None:
        """Test creating a baseline cost element entry."""
        # Create a user
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_cost_element.py:27:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________ test_baseline_cost_element_relationships ___________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_cost_element_relationships(db: Session) -> None:
        """Test that baseline cost element references baseline log and cost element correctly."""
        # Create a user
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_cost_element.py:150:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________ test_baseline_cost_element_decimal_fields ___________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_cost_element_decimal_fields(db: Session) -> None:
        """Test that decimal fields are handled correctly."""
        # Create a user
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_cost_element.py:260:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________________ test_create_baseline_log ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_baseline_log(db: Session) -> None:
        """Test creating a baseline log entry."""
        # Create a user
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_log.py:24:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________________ test_baseline_type_enum ____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_type_enum(db: Session) -> None:
        """Test that baseline_type is validated."""
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_log.py:73:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_______________________ test_baseline_user_relationship ________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_user_relationship(db: Session) -> None:
        """Test that baseline log references user correctly."""
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_log.py:111:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
____________________ test_baseline_log_is_cancelled_default ____________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_log_is_cancelled_default(db: Session) -> None:
        """Test that is_cancelled defaults to False."""
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_log.py:179:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
____________________ test_baseline_log_milestone_type_enum _____________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_log_milestone_type_enum(db: Session) -> None:
        """Test that milestone_type is validated."""
        email = f"user_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_log.py:215:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_create_baseline_snapshot _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_baseline_snapshot(db: Session) -> None:
        """Test creating a baseline snapshot."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_snapshot.py:23:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
____________________ test_baseline_snapshot_milestone_enum _____________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_snapshot_milestone_enum(db: Session) -> None:
        """Test that milestone_type is validated."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_snapshot.py:67:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________ test_baseline_snapshot_with_baseline_log ___________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_snapshot_with_baseline_log(db: Session) -> None:
        """Test that baseline snapshot can be linked to baseline log."""
        from decimal import Decimal

        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_snapshot.py:145:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_________________ test_baseline_snapshot_without_baseline_log __________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_baseline_snapshot_without_baseline_log(db: Session) -> None:
        """Test that baseline snapshot can exist without baseline log (nullable)."""
        from decimal import Decimal

        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_baseline_snapshot.py:204:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_create_budget_allocation _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_budget_allocation(db: Session) -> None:
        """Test creating a budget allocation."""
        # Create full hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_budget_allocation.py:30:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_allocation_type_enum ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_allocation_type_enum(db: Session) -> None:
        """Test that allocation_type is validated."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_budget_allocation.py:115:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
____________________ test_budget_cost_element_relationship _____________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_budget_cost_element_relationship(db: Session) -> None:
        """Test that budget allocation references cost element correctly."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_budget_allocation.py:191:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________________ test_create_change_order ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_change_order(db: Session) -> None:
        """Test creating a change order."""
        # Create user
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_change_order.py:24:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_change_order_status_enum _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_change_order_status_enum(db: Session) -> None:
        """Test that change order status is validated."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_change_order.py:73:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________________ test_create_cost_element ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_cost_element(db: Session) -> None:
        """Test creating a cost element."""
        # Create hierarchy: User -> Project -> WBE -> CostElementType -> CostElement
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_element.py:28:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_________________________ test_cost_element_hierarchy __________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_element_hierarchy(db: Session) -> None:
        """Test the full hierarchy: Project -> WBE -> CostElement."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_element.py:104:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_________________________ test_cost_element_validation _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_element_validation(db: Session) -> None:
        """Test cost element validation rules."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_element.py:169:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_____________________ test_cost_element_type_relationship ______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_element_type_relationship(db: Session) -> None:
        """Test that cost element references cost element type correctly."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_element.py:231:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
______________________ test_create_cost_element_schedule _______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_cost_element_schedule(db: Session) -> None:
        """Test creating a cost element schedule."""
        # Create full hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_element_schedule.py:30:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_progression_type_enum __________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_progression_type_enum(db: Session) -> None:
        """Test that progression_type is validated."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_element_schedule.py:113:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_create_cost_element_type _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_cost_element_type(db: Session) -> None:
        """Test creating a cost element type."""
        unique_code = f"test_{uuid.uuid4().hex[:8]}"
        cet_in = CostElementTypeCreate(
            type_code=unique_code,
            type_name="Robot Mechanical Engineering",
            category_type="engineering_mechanical",
            tracks_hours=True,
            display_order=1,
            is_active=True,
        )

        cet = CostElementType.model_validate(cet_in)
        db.add(cet)
>       db.commit()

tests/models/test_cost_element_type.py:30:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
______________________ test_cost_element_type_unique_code ______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_element_type_unique_code(db: Session) -> None:
        """Test that type_code must be unique."""
        unique_code = f"DUPLICATE_{uuid.uuid4().hex[:8]}"
        cet1_in = CostElementTypeCreate(
            type_code=unique_code,
            type_name="Duplicate Test",
            category_type="other",
            display_order=1,
            is_active=True,
        )
        cet1 = CostElementType.model_validate(cet1_in)
        db.add(cet1)
>       db.commit()

tests/models/test_cost_element_type.py:55:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_____________________ test_cost_element_type_category_enum _____________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_element_type_category_enum(db: Session) -> None:
        """Test that category_type enum is validated."""
        # Valid category
        unique_code = f"test_eng_{uuid.uuid4().hex[:8]}"
        cet_in = CostElementTypeCreate(
            type_code=unique_code,
            type_name="Test Engineering",
            category_type="engineering_mechanical",
            display_order=1,
            is_active=True,
        )
        cet = CostElementType.model_validate(cet_in)
        db.add(cet)
>       db.commit()

tests/models/test_cost_element_type.py:90:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________ test_cost_element_type_department_relationship ________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_element_type_department_relationship(db: Session) -> None:
        """Test that CostElementType can have a department relationship."""
        # Create a department first
        dept_in = DepartmentCreate(
            department_code="TEST_DEPT",
            department_name="Test Department",
            description="Test department for cost element types",
            is_active=True,
        )
        dept = Department.model_validate(dept_in)
        db.add(dept)
>       db.commit()

tests/models/test_cost_element_type.py:148:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________ test_cost_element_type_without_department ___________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_element_type_without_department(db: Session) -> None:
        """Test that CostElementType can exist without a department (nullable)."""
        unique_code = f"test_no_dept_{uuid.uuid4().hex[:8]}"
        cet_in = CostElementTypeCreate(
            type_code=unique_code,
            type_name="Test Type without Department",
            category_type="other",
            tracks_hours=False,
            display_order=1,
            is_active=True,
        )
        cet = CostElementType.model_validate(cet_in)
        # department_id should be None by default
        assert cet.department_id is None
        db.add(cet)
>       db.commit()

tests/models/test_cost_element_type.py:189:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_create_cost_registration _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_cost_registration(db: Session) -> None:
        """Test creating a cost registration."""
        # Create full hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_registration.py:30:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________________ test_cost_category_enum ____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_cost_category_enum(db: Session) -> None:
        """Test that cost_category is validated."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_cost_registration.py:117:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
____________________________ test_create_department ____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_department(db: Session) -> None:
        """Test creating a department."""
        unique_code = f"test_{uuid.uuid4().hex[:8]}"
        dept_in = DepartmentCreate(
            department_code=unique_code,
            department_name="Engineering",
            description="Engineering department",
            is_active=True,
        )

        dept = Department.model_validate(dept_in)
        db.add(dept)
>       db.commit()

tests/models/test_department.py:21:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_________________________ test_department_unique_code __________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_department_unique_code(db: Session) -> None:
        """Test that department_code must be unique."""
        unique_code = f"DUP_{uuid.uuid4().hex[:8]}"
        dept1_in = DepartmentCreate(
            department_code=unique_code,
            department_name="Duplicate Test",
            is_active=True,
        )
        dept1 = Department.model_validate(dept1_in)
        db.add(dept1)
>       db.commit()

tests/models/test_department.py:42:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_create_earned_value_entry ________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_earned_value_entry(db: Session) -> None:
        """Test creating an earned value entry."""
        # Create full hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_earned_value_entry.py:30:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_____________________________ test_create_forecast _____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_forecast(db: Session) -> None:
        """Test creating a forecast."""
        # Create full hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_forecast.py:30:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________________ test_forecast_type_enum ____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_forecast_type_enum(db: Session) -> None:
        """Test that forecast_type is validated."""
        # Create hierarchy
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_forecast.py:114:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_____________________ test_user_model_structure_unchanged ______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_user_model_structure_unchanged(db):
        """
        Test that User model structure is identical to original after migration.
        This ensures we haven't broken existing functionality.
        """
        import uuid

        from app import crud
        from app.models import UserCreate

        # Create a user using existing CRUD operations with unique email
        email = f"test_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       user = crud.create_user(session=db, user_create=user_in)

tests/models/test_model_imports.py:55:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_____________________________ test_create_project ______________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_project(db: Session) -> None:
        """Test creating a project."""
        # First create a user to be the project manager
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_project.py:22:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
___________________________ test_project_status_enum ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_project_status_enum(db: Session) -> None:
        """Test that project status is validated."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_project.py:59:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_project_validation_rules _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_project_validation_rules(db: Session) -> None:
        """Test project field validation rules."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_project.py:85:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_project_relationships __________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_project_relationships(db: Session) -> None:
        """Test project relationships with User."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_project.py:112:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_create_project_event ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_project_event(db: Session) -> None:
        """Test creating a project event."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_project_event.py:23:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_________________________ test_project_event_type_enum _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_project_event_type_enum(db: Session) -> None:
        """Test that event_type is validated."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_project_event.py:69:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_create_project_phase ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_project_phase(db: Session) -> None:
        """Test creating a project phase."""
        unique_id = uuid.uuid4().hex[:8]
        phase_in = ProjectPhaseCreate(
            phase_code=f"test_aperture_{unique_id}",
            phase_name="Opening/Kickoff",
            description="Project kickoff phase",
            display_order=1,
        )

        phase = ProjectPhase.model_validate(phase_in)
        db.add(phase)
>       db.commit()

tests/models/test_project_phase.py:25:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_project_phase_unique_code ________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_project_phase_unique_code(db: Session) -> None:
        """Test that phase_code must be unique."""
        unique_id = uuid.uuid4().hex[:8]
        phase1_in = ProjectPhaseCreate(
            phase_code=f"dup_{unique_id}",
            phase_name="Duplicate Test",
            display_order=1,
        )
        phase1 = ProjectPhase.model_validate(phase1_in)
        db.add(phase1)
>       db.commit()

tests/models/test_project_phase.py:46:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_______________________ test_project_phase_display_order _______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_project_phase_display_order(db: Session) -> None:
        """Test creating phases with different display orders."""
        import uuid

        # Use unique codes to avoid conflicts
        unique_id = uuid.uuid4().hex[:8]
        phase1 = ProjectPhase.model_validate(
            ProjectPhaseCreate(
                phase_code=f"order1_{unique_id}",
                phase_name="Order 1",
                display_order=1,
            )
        )
        phase2 = ProjectPhase.model_validate(
            ProjectPhaseCreate(
                phase_code=f"order2_{unique_id}",
                phase_name="Order 2",
                display_order=2,
            )
        )

        db.add(phase1)
        db.add(phase2)
>       db.commit()

tests/models/test_project_phase.py:89:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
__________________________ test_create_quality_event ___________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_quality_event(db: Session) -> None:
        """Test creating a quality event."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_quality_event.py:23:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
______________________ test_quality_event_root_cause_enum ______________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_quality_event_root_cause_enum(db: Session) -> None:
        """Test that root_cause is validated."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_quality_event.py:70:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_quality_event_status_enum ________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_quality_event_status_enum(db: Session) -> None:
        """Test that status is validated."""
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_quality_event.py:119:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_______________________________ test_create_wbe ________________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_create_wbe(db: Session) -> None:
        """Test creating a WBE."""
        # Create a project first
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_wbe.py:24:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
________________________ test_wbe_project_relationship _________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_wbe_project_relationship(db: Session) -> None:
        """Test that WBE can be accessed through project relationship."""
        # Create a project
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_wbe.py:72:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
_____________________________ test_wbe_status_enum _____________________________

db = <sqlmodel.orm.session.Session object at 0x7f71049299a0>

    def test_wbe_status_enum(db: Session) -> None:
        """Test that WBE status is validated."""
        # Create a project
        email = f"pm_{uuid.uuid4().hex[:8]}@example.com"
        password = "testpassword123"
        user_in = UserCreate(email=email, password=password)
>       pm_user = crud.create_user(session=db, user_create=user_in)

tests/models/test_wbe.py:121:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app/crud.py:14: in create_user
    session.commit()
.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:2028: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py:103: in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.orm.session.SessionTransaction object at 0x7f7104b0cc90>
operation_name = 'commit', state = <SessionTransactionState.DEACTIVE: 4>

    def _raise_for_prerequisite_state(
        self, operation_name: str, state: _StateChangeState
    ) -> NoReturn:
        if state is SessionTransactionState.DEACTIVE:
            if self._rollback_exception:
>               raise sa_exc.PendingRollbackError(
                    "This Session's transaction has been rolled back "
                    "due to a previous exception during flush."
                    " To begin a new transaction with this Session, "
                    "first issue Session.rollback()."
                    f" Original exception was: {self._rollback_exception}",
                    code="7s2a",
                )
E               sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block
E               [SQL: INSERT INTO "user" (email, is_active, role, department, full_name, id, hashed_password, created_at, updated_at) VALUES (%(email)s::VARCHAR, %(is_active)s, %(role)s, %(department)s::VARCHAR, %(full_name)s::VARCHAR, %(id)s::UUID, %(hashed_password)s::VARCHAR, %(created_at)s::TIMESTAMP WITH TIME ZONE, %(updated_at)s::TIMESTAMP WITH TIME ZONE)]
E               [parameters: {'email': 'zxmiltfrmffjerusyrusbbeuowvvclvh@uiswomzoishkhgkfvotfizyfrglsbutx.com', 'is_active': True, 'role': 'controller', 'department': None, 'full_name': None, 'id': UUID('0086cb87-b9a8-4454-a7a4-2eed061a192a'), 'hashed_password': '$2b$12$bhHoqbVzSkxa.Stg1VXusOtk0/SRtI9KVYbouMvu474TyDsaQpVGW', 'created_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357011), 'updated_at': datetime.datetime(2025, 11, 5, 6, 5, 40, 357020)}]
E               (Background on this error at: https://sqlalche.me/e/20/2j85) (Background on this error at: https://sqlalche.me/e/20/7s2a)

.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py:973: PendingRollbackError
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/starlette/formparsers.py:12
  /home/nicola/dev/E80_pm_mockup/backend/.venv/lib/python3.12/site-packages/starlette/formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

app/core/config.py:104
  /home/nicola/dev/E80_pm_mockup/backend/app/core/config.py:104: UserWarning: The value of SECRET_KEY is "changethis", for security, please change it, at least for deployments.
    warnings.warn(message, stacklevel=1)

app/core/config.py:104
  /home/nicola/dev/E80_pm_mockup/backend/app/core/config.py:104: UserWarning: The value of POSTGRES_PASSWORD is "changethis", for security, please change it, at least for deployments.
    warnings.warn(message, stacklevel=1)

app/core/config.py:104
  /home/nicola/dev/E80_pm_mockup/backend/app/core/config.py:104: UserWarning: The value of FIRST_SUPERUSER_PASSWORD is "changethis", for security, please change it, at least for deployments.
    warnings.warn(message, stacklevel=1)

.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854
  /home/nicola/dev/E80_pm_mockup/backend/.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

tests/api/routes/test_baseline_cost_elements_by_wbe.py: 165 warnings
tests/api/routes/test_baseline_cost_elements_list.py: 58 warnings
tests/api/routes/test_baseline_logs.py: 137 warnings
tests/api/routes/test_baseline_snapshot_summary.py: 45 warnings
tests/api/routes/test_budget_summary.py: 38 warnings
tests/api/routes/test_budget_timeline.py: 144 warnings
tests/api/routes/test_cost_element_schedules.py: 88 warnings
tests/api/routes/test_cost_element_types.py: 10 warnings
tests/api/routes/test_cost_elements.py: 196 warnings
tests/api/routes/test_cost_registrations.py: 168 warnings
tests/api/routes/test_cost_summary.py: 84 warnings
tests/api/routes/test_login.py: 4 warnings
tests/api/routes/test_projects.py: 54 warnings
tests/api/routes/test_users.py: 28 warnings
tests/api/routes/test_wbes.py: 80 warnings
tests/crud/test_user.py: 16 warnings
tests/models/test_audit_log.py: 4 warnings
tests/models/test_baseline_cost_element.py: 6 warnings
tests/models/test_baseline_log.py: 10 warnings
tests/models/test_baseline_snapshot.py: 8 warnings
tests/models/test_budget_allocation.py: 6 warnings
tests/models/test_change_order.py: 4 warnings
tests/models/test_cost_element.py: 8 warnings
tests/models/test_cost_element_schedule.py: 4 warnings
tests/models/test_cost_element_type.py: 8 warnings
tests/models/test_cost_registration.py: 4 warnings
tests/models/test_earned_value_entry.py: 4 warnings
tests/models/test_forecast.py: 4 warnings
tests/models/test_model_imports.py: 2 warnings
tests/models/test_project.py: 8 warnings
tests/models/test_project_event.py: 4 warnings
tests/models/test_quality_event.py: 6 warnings
tests/models/test_wbe.py: 6 warnings
  /home/nicola/dev/E80_pm_mockup/backend/.venv/lib/python3.12/site-packages/sqlmodel/_compat.py:321: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    cls.__pydantic_validator__.validate_python(

tests/api/routes/test_baseline_logs.py::test_create_baseline_snapshot_aggregates_actual_cost
tests/api/routes/test_baseline_logs.py::test_create_baseline_snapshot_aggregates_actual_cost
tests/api/routes/test_baseline_logs.py::test_create_baseline_snapshot_aggregates_actual_cost
tests/api/routes/test_baseline_logs.py::test_create_baseline_snapshot_aggregates_actual_cost
tests/api/routes/test_private.py::test_create_user
tests/api/routes/test_private.py::test_create_user
  /home/nicola/dev/E80_pm_mockup/backend/.venv/lib/python3.12/site-packages/pydantic/fields.py:747: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

tests/api/routes/test_baseline_logs.py: 2 warnings
tests/api/routes/test_cost_element_schedules.py: 3 warnings
tests/api/routes/test_cost_elements.py: 7 warnings
tests/api/routes/test_cost_registrations.py: 2 warnings
tests/api/routes/test_projects.py: 2 warnings
tests/api/routes/test_users.py: 5 warnings
tests/api/routes/test_wbes.py: 3 warnings
  /home/nicola/dev/E80_pm_mockup/backend/.venv/lib/python3.12/site-packages/sqlmodel/_compat.py:106: PydanticDeprecatedSince211: Accessing the 'model_fields' attribute on the instance is deprecated. Instead, you should access this attribute from the model class. Deprecated in Pydantic V2.11 to be removed in V3.0.
    return model.model_fields

tests/api/routes/test_budget_summary.py: 4 warnings
tests/api/routes/test_cost_summary.py: 7 warnings
  /home/nicola/dev/E80_pm_mockup/backend/.venv/lib/python3.12/site-packages/sqlmodel/_compat.py:351: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    self.__pydantic_validator__.validate_python(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/core/test_seeds.py::test_seed_order_departments_first - sqlalche...
FAILED tests/core/test_seeds.py::test_seed_cost_element_types_still_works - s...
FAILED tests/core/test_seeds.py::test_seed_cost_element_types_with_hardcoded_uuids
FAILED tests/core/test_seeds.py::test_seed_project_from_template_creates_project
FAILED tests/core/test_seeds.py::test_seed_project_from_template_idempotent
FAILED tests/core/test_seeds.py::test_seed_project_from_template_missing_file
FAILED tests/core/test_seeds.py::test_integration_all_seeds_together - sqlalc...
FAILED tests/core/test_seeds.py::test_seed_project_from_template_creates_budget_allocations_and_schedules
FAILED tests/crud/test_user.py::test_create_user - sqlalchemy.exc.InternalErr...
FAILED tests/crud/test_user.py::test_authenticate_user - sqlalchemy.exc.Pendi...
FAILED tests/crud/test_user.py::test_not_authenticate_user - sqlalchemy.exc.P...
FAILED tests/crud/test_user.py::test_check_if_user_is_active - sqlalchemy.exc...
FAILED tests/crud/test_user.py::test_check_if_user_is_active_inactive - sqlal...
FAILED tests/crud/test_user.py::test_check_if_user_is_admin - sqlalchemy.exc....
FAILED tests/crud/test_user.py::test_check_if_user_is_normal_user - sqlalchem...
FAILED tests/crud/test_user.py::test_get_user - sqlalchemy.exc.PendingRollbac...
FAILED tests/crud/test_user.py::test_update_user - sqlalchemy.exc.PendingRoll...
FAILED tests/models/test_audit_log.py::test_create_audit_log - sqlalchemy.exc...
FAILED tests/models/test_audit_log.py::test_audit_log_action_enum - sqlalchem...
FAILED tests/models/test_baseline_cost_element.py::test_create_baseline_cost_element
FAILED tests/models/test_baseline_cost_element.py::test_baseline_cost_element_relationships
FAILED tests/models/test_baseline_cost_element.py::test_baseline_cost_element_decimal_fields
FAILED tests/models/test_baseline_log.py::test_create_baseline_log - sqlalche...
FAILED tests/models/test_baseline_log.py::test_baseline_type_enum - sqlalchem...
FAILED tests/models/test_baseline_log.py::test_baseline_user_relationship - s...
FAILED tests/models/test_baseline_log.py::test_baseline_log_is_cancelled_default
FAILED tests/models/test_baseline_log.py::test_baseline_log_milestone_type_enum
FAILED tests/models/test_baseline_snapshot.py::test_create_baseline_snapshot
FAILED tests/models/test_baseline_snapshot.py::test_baseline_snapshot_milestone_enum
FAILED tests/models/test_baseline_snapshot.py::test_baseline_snapshot_with_baseline_log
FAILED tests/models/test_baseline_snapshot.py::test_baseline_snapshot_without_baseline_log
FAILED tests/models/test_budget_allocation.py::test_create_budget_allocation
FAILED tests/models/test_budget_allocation.py::test_allocation_type_enum - sq...
FAILED tests/models/test_budget_allocation.py::test_budget_cost_element_relationship
FAILED tests/models/test_change_order.py::test_create_change_order - sqlalche...
FAILED tests/models/test_change_order.py::test_change_order_status_enum - sql...
FAILED tests/models/test_cost_element.py::test_create_cost_element - sqlalche...
FAILED tests/models/test_cost_element.py::test_cost_element_hierarchy - sqlal...
FAILED tests/models/test_cost_element.py::test_cost_element_validation - sqla...
FAILED tests/models/test_cost_element.py::test_cost_element_type_relationship
FAILED tests/models/test_cost_element_schedule.py::test_create_cost_element_schedule
FAILED tests/models/test_cost_element_schedule.py::test_progression_type_enum
FAILED tests/models/test_cost_element_type.py::test_create_cost_element_type
FAILED tests/models/test_cost_element_type.py::test_cost_element_type_unique_code
FAILED tests/models/test_cost_element_type.py::test_cost_element_type_category_enum
FAILED tests/models/test_cost_element_type.py::test_cost_element_type_department_relationship
FAILED tests/models/test_cost_element_type.py::test_cost_element_type_without_department
FAILED tests/models/test_cost_registration.py::test_create_cost_registration
FAILED tests/models/test_cost_registration.py::test_cost_category_enum - sqla...
FAILED tests/models/test_department.py::test_create_department - sqlalchemy.e...
FAILED tests/models/test_department.py::test_department_unique_code - sqlalch...
FAILED tests/models/test_earned_value_entry.py::test_create_earned_value_entry
FAILED tests/models/test_forecast.py::test_create_forecast - sqlalchemy.exc.P...
FAILED tests/models/test_forecast.py::test_forecast_type_enum - sqlalchemy.ex...
FAILED tests/models/test_model_imports.py::test_user_model_structure_unchanged
FAILED tests/models/test_project.py::test_create_project - sqlalchemy.exc.Pen...
FAILED tests/models/test_project.py::test_project_status_enum - sqlalchemy.ex...
FAILED tests/models/test_project.py::test_project_validation_rules - sqlalche...
FAILED tests/models/test_project.py::test_project_relationships - sqlalchemy....
FAILED tests/models/test_project_event.py::test_create_project_event - sqlalc...
FAILED tests/models/test_project_event.py::test_project_event_type_enum - sql...
FAILED tests/models/test_project_phase.py::test_create_project_phase - sqlalc...
FAILED tests/models/test_project_phase.py::test_project_phase_unique_code - s...
FAILED tests/models/test_project_phase.py::test_project_phase_display_order
FAILED tests/models/test_quality_event.py::test_create_quality_event - sqlalc...
FAILED tests/models/test_quality_event.py::test_quality_event_root_cause_enum
FAILED tests/models/test_quality_event.py::test_quality_event_status_enum - s...
FAILED tests/models/test_wbe.py::test_create_wbe - sqlalchemy.exc.PendingRoll...
FAILED tests/models/test_wbe.py::test_wbe_project_relationship - sqlalchemy.e...
FAILED tests/models/test_wbe.py::test_wbe_status_enum - sqlalchemy.exc.Pendin...
ERROR tests/scripts/test_test_pre_start.py::test_init_successful_connection
====== 70 failed, 199 passed, 1457 warnings, 1 error in 120.96s (0:02:00) ======
